import tensorflow as tf                    #load trained CNN model
import cv2                                 #mage processing & display
import numpy as np                         #array handling
from tkinter import filedialog, Tk         #file selection popup

IMG_SIZE = (128, 128)

# Load model                #Loads the CNN trained earlier
model = tf.keras.models.load_model("leaf_disease_model.h5")

# Load class names             #Ensures correct label mapping
dataset = tf.keras.utils.image_dataset_from_directory(
    "dataset", image_size=IMG_SIZE, batch_size=1
)
class_names = dataset.class_names

# File chooser popup
root = Tk()
root.withdraw()
img_path = filedialog.askopenfilename(title="Select Leaf Image") #User selects a leaf image for testing

# Read image
img = cv2.imread(img_path)
img_resized = cv2.resize(img, IMG_SIZE)
img_norm = img_resized / 255.0
img_input = np.expand_dims(img_norm, axis=0)

# Prediction
pred = model.predict(img_input)
class_index = np.argmax(pred)         #argmax=predicted class
label = class_names[class_index]
confidence = pred[0][class_index] * 100       #Confidence (%) shows how sure the model is

# Bounding box (full leaf)
h, w, _ = img.shape                       #Draws bounding box around the leaf
cv2.rectangle(img, (10, 10), (w - 10, h - 10), (0, 255, 0), 2)  #Green rectangle for visibility

# ---------- AUTO-FIT TEXT FUNCTION ----------      ##Prevents text from going outside image
def put_text_fit(img, text, x, y, color):
    font = cv2.FONT_HERSHEY_SIMPLEX
    thickness = 2
    max_width = img.shape[1] - 20

    font_scale = 1.0
    (text_w, _), _ = cv2.getTextSize(text, font, font_scale, thickness)

    while text_w > max_width:
        font_scale -= 0.05
        (text_w, _), _ = cv2.getTextSize(text, font, font_scale, thickness)

    cv2.putText(img, text, (x, y),
                font, font_scale, color, thickness)

# Text on image (FIXED)
put_text_fit(img, f"Disease: {label}", 10, 35, (0, 0, 255))
put_text_fit(img, f"Accuracy: {confidence:.2f}%", 10, 70, (255, 0, 0))

#Predicted disease
#Prediction confidence

# Show output                #Displays final result
cv2.imshow("Leaf Disease Detection", img)
cv2.waitKey(0)
cv2.destroyAllWindows()

